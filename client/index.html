<!DOCTYPE html>
<html>
    <head>
        <title>PER WebSocket Demo</title>

        <script src="smoothie.js"></script>
        <script src="randomColor.js"></script>
        <link rel="stylesheet" href="style.css">


    </head>
    <body>  

        <div id='data_tx'>
            <input id='tx_message'>
            <button id='send'>Send</button>
            <button id='disconnect'>Disconnect</button>
        </div>
        <div id='connection_pannel'>
            <input id='ws_address'>
            <button id='connect'>Connect</button>
        </div>
        <p id='rx_messages'></p>


        <input id='filter' onkeyup="filerCharts()" placeholder="Filter...">
        <ul id="chart_area" style="height: 500px; width: 100%;">
        
        </ul>

    
    
        <script>
            let connection_panel = document.getElementById('connection_pannel')
            let address = document.getElementById('ws_address');
            let connect = document.getElementById('connect');

            let data_tx_panel = document.getElementById('data_tx')
            let tx_message = document.getElementById('tx_message');
            let btn_send = document.getElementById('send');
            let disconnect = document.getElementById('disconnect');
            let rx_message = document.getElementById('rx_messages');

            let chart_area = document.getElementById('chart_area')

            address.value = 'ws://192.168.4.1:5000'
            var ws;

            hideAll(data_tx)

            connect.onclick = function(ev) {
                ws = new WebSocket(address.value);

                // When we conenct to the Socket, tell the car that we are here
                ws.onopen = function () {
                    ws.send('Ping');
                    showAll(data_tx_panel)
                    hideAll(connection_panel)
                };

                ws.onclose = function() {
                    rx_message.innerHTML = (new Date().toTimeString().split("(")[0] + " - Server Closed <br>" + rx_message.innerHTML)
                    showAll(connection_panel)
                    hideAll(data_tx_panel)
                    setAllChartsEnabled(false)
                }

                ws.onerror = function (error) {
                    console.error('WebSocket Error ' + error);
                    ws = null;
                };

                ws.onmessage = function (e) {
                    rx_message.innerHTML = (new Date().toTimeString().split("(")[0] + " - " + e.data + "<br>" + rx_message.innerHTML).substring(0, 2000)
                    data_JSON = JSON.parse(e.data)
                    if(data_JSON.type === 'data'){
                        onGetCANData(data_JSON)
                    }
                };
            }
            
            // Broadcast tx_message to the car
            btn_send.onclick = function(ev) {
                if(ws){
                    ws.send(tx_message.value)
                    tx_message.value = ''
                }
            }

            disconnect.onclick = function(e){
                ws.close()
                rx_message.innerHTML = new Date().toTimeString().split("(")[0] + " - Client Closed <br>" + rx_message.innerHTML
                showAll(connection_panel)
                hideAll(data_tx_panel)
            }

            function setAllChartsEnabled(enabled) {
                for(i in allCharts){
                    allCharts[i].setEnabled(enabled)
                }
            }


            function onGetCANData(data){
                var id = data.payload.id
                var timestamp = new Date(data.payload.timestamp).getTime()
                var payload_data = parseInt(data.payload.message, 16)              

                var chart = allCharts[id] 
                if(!chart){
                    chart = new CANDataChart(id)
                    allCharts[id] = chart
                }

                chart.addData(timestamp, payload_data)
            }
            
            var allCharts = {}

            class CANDataChart {
                constructor(id) {
                    this.id = id
                    
                    this.container = document.createElement('li')
                    
                    this.canvas = document.createElement('canvas')
                    this.canvas.height = 240
                    this.canvas.width = 625 * 2

                    this.series = new TimeSeries();
                    var chart_title = dict[id] ? id + ": " + dict[id] : id + ': Unknown'

                    this.container.id = chart_title
                    this.colorStyle = randomColor({luminosity: 'dark',})

                    this.chart = new SmoothieChart({
                            grid:{ fillStyle:'#ffffff', verticalSections:5 }, 
                            labels: { fillStyle:'#000000' }, 
                            title: { text:chart_title, fillStyle:'#000000' },
                            tooltip: true, 
                            timestampFormatter: SmoothieChart.timeFormatter,
                            // minValue: 0,
                            // maxValue: 255
                        })
                    this.chart.addTimeSeries(this.series, {lineWidth:2, strokeStyle:this.colorStyle});
                    this.chart.streamTo(this.canvas, 1500);

                    
                    this.container.appendChild(this.canvas)
                    chart_area.appendChild(this.container)
                }

                addData (timestamp, data) {
                    this.series.append(timestamp, data)
                }

                setEnabled (enabled){
                    if(enabled){
                        this.chart.start()
                    } else {
                        this.chart.stop()
                    }
                }
                
            }

            can_bus_index = 0
            count = 0
            setInterval(function() {
                if(count > 100){
                    return;
                } 

                data = {}
                data.payload = {}

                var keys = Object.keys(dict)
                random_id = keys[can_bus_index++];
                can_bus_index %= keys.length
                count ++
                

                data.payload.id = random_id.toString()
                data.payload.message = 'FF'
                data.payload.timestamp = new Date().getTime()
                
                onGetCANData(data)
            }, 1);


            
            function filerCharts() {
                ul = document.getElementById("chart_area");
                li = ul.getElementsByTagName('li');
                filter = document.getElementById('filter').value.toUpperCase();

                for (i = 0; i < li.length; i++) {
                    a = li[i].id
                    if (a.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                    } else {
                        li[i].style.display = "none";
                    }
                }
            }






            function hideAll(elm) {
                var children = elm.children;
                for (var i = 0; i < children.length; i++) {
                    var elm = children[i];
                    elm.style.display='none'
                }   
            }
            function showAll(elm) {
                var children = elm.children;
                for (var i = 0; i < children.length; i++) {
                    var elm = children[i];
                    elm.style.display='inline'
                } 
            }

            var dict = {
                '215': 'Coolant_Flow',
                '500': 'Pedal_Box1',
                '501': 'Pedal_Box2',
                '502': 'Pedal_Box3',
                '181': 'Motor_Controller',
                '300': 'Dash_High',
                '301': 'Dash_Low',
                '401': 'BMS',
                '402': 'BMS',
                '403': 'BMS',
                '404': 'BMS',
                '405': 'BMS',
                '406': 'BMS',
                '407': 'BMS',
                '408': 'BMS',
                '03B': 'BMS',
                '03C': 'BMS',
                '200': 'Wheel_Spd_FR',
                '201': 'Wheel_Spd_FL',
                '202': 'Wheel_Spd_RR',
                '202': 'Wheel_Spd_RL',
                '210': 'Pedal_Box-Torque',
                '503': 'Calibrate',
                '350': 'Dashboard',
                '420': 'Accelerometer',
                '421': 'Accel, Gyro',
                '422': 'Steering Angle'
            };
            
        </script>
    </body>
</html>